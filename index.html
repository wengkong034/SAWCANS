<!DOCTYPE html>
<html>
<head>
  <title>Smart Bin Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <style>
    #map { height: 100vh; margin: 0; display: none; }
    body { margin: 0; font-family: Arial, sans-serif; }
    #loginBox {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    input, button {
      margin: 5px;
      padding: 10px;
      width: 250px;
    }
  </style>
</head>
<body>
  <!-- Login Form -->
  <div id="loginBox">
    <h2>Login to Smart Bin</h2>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <!-- Map -->
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <script>
    // === 1. Firebase Config ===
    const firebaseConfig = {
      apiKey: "AIzaSyAZeemtLknIl5GiUkVVJzkL5GAWVH2Ur74",
      authDomain: "esp32-tutorial-859c8.firebaseapp.com",
      databaseURL: "https://esp32-tutorial-859c8-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "esp32-tutorial-859c8",
      storageBucket: "esp32-tutorial-859c8.appspot.com",
      messagingSenderId: "618650746243",
      appId: "1:618650746243:web:313250578e82d38d354ab6"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    // === 2. Login Function ===
    function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      auth.signInWithEmailAndPassword(email, password)
        .then(() => {
          document.getElementById("loginBox").style.display = "none";
          document.getElementById("map").style.display = "block";
          initMap(); // load map after login
        })
        .catch(error => {
          document.getElementById("loginError").innerText = error.message;
        });
    }

    // === 3. Map + Firebase Data ===
    function initMap() {
      const map = L.map('map').setView([5.4525, 100.2845], 17);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      function getMarkerColor(status) {
        switch (status.toLowerCase()) {
          case "full": return "red";
          case "moderate": return "orange";
          case "low": return "yellow";
          case "empty": return "green";
          default: return "blue";
        }
      }

      function createColoredIcon(color) {
        return new L.Icon({
          iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
          shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        });
      }

      const markers = {};
      let routeControl = null;

      navigator.geolocation.getCurrentPosition(position => {
        const depotLatLng = L.latLng(position.coords.latitude, position.coords.longitude);
        L.marker(depotLatLng, { icon: createColoredIcon("blue") })
          .addTo(map)
          .bindPopup("<b>Depot Location</b>")
          .openPopup();

        db.ref('bins').on('value', snapshot => {
          const bins = snapshot.val();
          if (!bins) return;

          const selectedWaypoints = [depotLatLng];

          for (const key in bins) {
            const bin = bins[key];
            if (!bin.lat || !bin.lng) continue;

            const latlng = [bin.lat, bin.lng];
            const color = getMarkerColor(bin.status);
            const icon = createColoredIcon(color);

            if (markers[key]) {
              markers[key].setLatLng(latlng);
              markers[key].setIcon(icon);
              markers[key].getPopup().setContent(
                `<b>${bin.name}</b><br>Fill Level: ${bin.fill}<br>Status: ${bin.status}`
              );
            } else {
              const marker = L.marker(latlng, { icon })
                .addTo(map)
                .bindPopup(`<b>${bin.name}</b><br>Fill Level: ${bin.fill}<br>Status: ${bin.status}`);
              markers[key] = marker;
            }

            const status = bin.status.toLowerCase();
            if (status === "full" || status === "moderate") {
              selectedWaypoints.push(L.latLng(bin.lat, bin.lng));
            }
          }

          if (routeControl) {
            map.removeControl(routeControl);
          }

          if (selectedWaypoints.length > 1) {
            routeControl = L.Routing.control({
              waypoints: selectedWaypoints,
              createMarker: () => null,
              routeWhileDragging: false,
              fitSelectedRoutes: true,
              lineOptions: { styles: [{ color: 'red', weight: 4 }] },
              router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' })
            }).addTo(map);
          }
        });
      }, () => {
        alert("Failed to get current location. Please enable GPS or location services.");
      });
    }
  </script>
</body>
</html>
